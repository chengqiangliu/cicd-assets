---
- name: Install Kubernetes Dashboard
  hosts: azure_vms
  become: true
  tasks:
    - name: Create directories if they do not exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop:
        - /opt/services
        - /opt/services/k8s-dashboard

    - name: Copy files to remote server
      copy:
        src: "/home/cicd/workspace/cicd-assets/k8s-dashboard/"
        dest: "/opt/services/k8s-dashboard"
        mode: '0644'

    - name: Apply namespace
      command: kubectl apply -f /opt/services/k8s-dashboard/namespace.yaml

    - name: Apply service account
      command: kubectl apply -f /opt/services/k8s-dashboard/service-account.yaml

    - name: Apply cluster role binding
      command: kubectl apply -f /opt/services/k8s-dashboard/cluster-role-binding.yaml

    - name: Deploy Kubernetes Dashboard
      command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

    - name: Generate bearer token
      command: kubectl -n kubernetes-dashboard create token admin-user
      register: bearer_token_output

    - name: Print bearer token
      debug:
        var: bearer_token_output.stdout_lines[0]
