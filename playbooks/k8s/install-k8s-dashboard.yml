---
- name: Install Kubernetes Dashboard
  hosts: all
  become: true
  tasks:
    - name: Apply service account
      command: kubectl apply -f /opt/services/k8s-dashboard/service-account.yaml

    - name: Apply cluster role binding
      command: kubectl apply -f /opt/services/k8s-dashboard/cluster-role-binding.yaml

    - name: Deploy Kubernetes Dashboard
      command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.1/aio/deploy/recommended.yaml

    - name: Get secret name
      command: kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '{print $1}'
      register: secret_name_output

    - name: Generate bearer token
      command: kubectl -n kubernetes-dashboard describe secret {{ secret_name_output.stdout }} | grep '^token:' | awk '{print $2}'
      register: bearer_token_output

    - name: Print bearer token
      debug:
        var: bearer_token_output.stdout_lines[0]
