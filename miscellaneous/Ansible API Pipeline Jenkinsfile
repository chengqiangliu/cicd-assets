pipeline {
  agent {
    label 'ubuntu_slave1'
  }

  parameters {
    choice(name: 'APP', choices: ['api', 'mongo', 'kube-prometheus', 'k8s-dashboard'], description: 'Application name')
    choice(name: 'CMD', choices: ['install', 'uninstall', 'rollout', 'rollback', 'scale', 'history'], description: 'Command')
    string(name: 'change_cause', defaultValue: '', description: 'Change cause for rollout command', visibilityCondition: "CMD == 'rollout'")
    string(name: 'rollback_revision', defaultValue: '', description: 'Revision number for rollback command', visibilityCondition: "CMD == 'rollback'")
    string(name: 'new_replica_count', defaultValue: '', description: 'Replica count for scale command', visibilityCondition: "CMD == 'scale'")
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/chengqiangliu/cicd-assets.git'
      }
    }

    stage('Ansible Playbook') {
      steps {
        ansiblePlaybook(
          playbook: 'install-roles.yml',
          inventory: 'inventory/inventory.ini',
          extraVars: [
            'role': 'kubernetes',
            'cmd': "${params.CMD}",
            'app': "${params.APP}",
            'change_cause': "${params.change_cause}",
            'rollback_revision': "${params.rollback_revision}",
            'new_replica_count': "${params.new_replica_count}"
          ]
        )
      }
    }
  }
}
